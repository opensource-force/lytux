#!/bin/bash

#set -eEu

if [[ -f /usr/local/bin/lytux-install ]]; then
  srcPath='/usr/local/share/lytux-install'
else
  srcPath='src'
fi

UEFI=0
locale=0
networking=0

while read -r line; do
  if [[ $line == 'vendor_id'* ]]; then
    VENDOR="${line#*:}" VENDOR="${VENDOR//[[:space:]]}"
    case $VENDOR in
      AuthenticAMD) UCODE='amd-ucode';; # amd microcode updates
      GenuineIntel) UCODE='intel-ucode';; # intel microcode udpates
    esac
    
    break
  fi
done </proc/cpuinfo

while read -r line; do
  if (( ${i:=0} == 18 )); then
    localeOptions+=("${line#\#}")
  else
    ((++i))
  fi
done </etc/locale.gen
unset i line

networkingOptions=(
  'iwd' # iwctl
  'networkmanager (recommended)' # nmcli/nmtui
  'wpa_supplicant' # systemd-networkd
)

selectedLocale= # locales to be generated

installPackages=(
  "$UCODE" # either amd or interl microcode updates
  'base' # system
  'linux' 'linux-firmware' 'linux-headers' # kernel
  'kitty' # terminal
  'pulseaudio' # audio
  'bluez' # bluetooth
  'sudo' # superuser
  'vim' # editor
  'sed' # stream editor
  'hyprland' # compositor/wm
  'hyprpaper' # wallpaper setter
  'waybar' # status bar
  'firefox' # browser
)

options=(
  'locale'
  'networking'
)

: '/sys/firmware/efi/fw_platform_size'
[[ -f $_ ]]&& read -rn 2 <"$_"

(( $REPLY == 64 ))&& UEFI=1

. "$srcPath/utils.sh"

trap 'deinit_term; exit 1' INT EXIT

init_term
draw_opts options
sbar

cursor="$ROWS"
for((;;)){
  (( networking&& locale ))&& . "$srcPath/newroot-setup.sh"

  hover_opts

  getin
  basic_keymap||{
    case $IN in
      l|\[C)
        for _ in "${options[@]% *}"; do
          [[ $HOVER == "$_" ]]&& . "$srcPath/${HOVER,}.sh"
        done
      ;;
      *) PAUSE=1;;
    esac
  }

  scroll_opts
}
