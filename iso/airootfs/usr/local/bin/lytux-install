#!/bin/bash

#set -eEu

#if [[ -f ${BASH_SOURCE[0]##*/} ]]; then
#  srcPath='src'
#else
#  srcPath="/usr/local/share/${BASH_SOURCE[0]##*/}"
#fi

srcPath="$HOME/git/lytux/iso/airootfs/usr/local/share/lytux-install"

UEFI=0
wifi=0
connected=0
locale=0
networking=0

options=(
  'networking'
  'locale'
)

: '/sys/firmware/efi/fw_platform_size'
[[ -f $_ ]]&& read -rn 2 <"$_"
(( $REPLY == 64 ))&& UEFI=1

ip link show eth0 2>/dev/null||{ options+=('wifi') selectedWifi=; }

while read -r line; do
  if [[ $line == 'vendor_id'* ]]; then
    VENDOR="${line#*:}" VENDOR="${VENDOR//[[:space:]]}"
    case $VENDOR in
      AuthenticAMD) UCODE='amd-ucode';; # amd microcode updates
      GenuineIntel) UCODE='intel-ucode';; # intel microcode udpates
    esac
    
    break
  fi
done </proc/cpuinfo

while read -r line; do
  if (( ${i:=0} == 18 )); then
    localeOptions+=("${line#\#}")
  else
    ((++i))
  fi
done </etc/locale.gen
unset i line
selectedLocale= # locales to be generated

networkingOptions=(
  'iwd' # iwctl
  'networkmanager (recommended)' # nmcli/nmtui
  'wpa_supplicant' # systemd-networkd
)

installPackages=(
  "$UCODE" # either amd or interl microcode updates
  'base' # system
  'linux' 'linux-firmware' 'linux-headers' # kernel
  'kitty' # terminal
  'pulseaudio' # audio
  'bluez' # bluetooth
  'sudo' # superuser
  'vim' # editor
  'sed' # stream editor
  'hyprland' # compositor/wm
  'hyprpaper' # wallpaper setter
  'waybar' # status bar
  'firefox' # browser
)

. "$srcPath/utils.sh"

trap 'deinit_term; exit 1' INT EXIT

init_term
draw_opts options
sbar

cursor="$ROWS"
for((;;)){
  #(( networking&& locale ))&& . "$srcPath/newroot-setup.sh"

  hover_opts

  getin
  basic_keymap||{
    case $IN in
      l|\[C)
        for _ in "${options[@]% *}"; do
          [[ $HOVER == "$_" ]]&& . "$srcPath/${HOVER,}.sh"
        done
      ;;
      *) PAUSE=1;;
    esac
  }

  scroll_opts
}
